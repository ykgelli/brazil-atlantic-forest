var agr = /* color: #9999ff */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-40.91089253277539, -16.185482623340192],
                  [-40.91175083966016, -16.18671905046103],
                  [-40.91187958569287, -16.187996683682645],
                  [-40.909605072448244, -16.188161538979802],
                  [-40.90990547985791, -16.18692512089486]]]),
            {
              "reference": 21,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-40.84932805592405, -16.251640784870773],
                  [-40.85250379139768, -16.25291799702905],
                  [-40.851130500382055, -16.25609039131511],
                  [-40.85228921467649, -16.257120378446384],
                  [-40.85027219349729, -16.25749117249191],
                  [-40.849885955399145, -16.254360000780476],
                  [-40.84898473317014, -16.253329999180544],
                  [-40.848641410416235, -16.252299992182405]]]),
            {
              "reference": 21,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.400529322559464, -22.90831601391703],
                  [-52.39988555803927, -22.906616261864485],
                  [-52.39572275070469, -22.90744644971587],
                  [-52.393319497632206, -22.904442059288257],
                  [-52.39173167699062, -22.90550931478194],
                  [-52.39314788335048, -22.9030978789867],
                  [-52.39632358976303, -22.90661624471262],
                  [-52.4011301373788, -22.90570697155221]]]),
            {
              "reference": 21,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.38353479327384, -22.904363017806258],
                  [-52.38662475102626, -22.897405139160455],
                  [-52.382794599379736, -22.899273163374154],
                  [-52.3789644449414, -22.897504016978786],
                  [-52.376539724149495, -22.899737548005326],
                  [-52.378299174244034, -22.896456325961342],
                  [-52.38271944750943, -22.8985912223643],
                  [-52.38816970341884, -22.896851665600778],
                  [-52.38447898381435, -22.903256007237808]]]),
            {
              "reference": 21,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.51890106258685, -22.755509080280916],
                  [-52.52156181392962, -22.761207757978912],
                  [-52.52623995222439, -22.755231687336742],
                  [-52.52751923277327, -22.752226278908193],
                  [-52.52261881277627, -22.747004589159022],
                  [-52.52346098493791, -22.743843344298966],
                  [-52.519309071409566, -22.74163695069852],
                  [-52.52485576906264, -22.74275534814638],
                  [-52.530745697596615, -22.739440695122397],
                  [-52.52370756906117, -22.74664384778495],
                  [-52.531260681727474, -22.7522638936819],
                  [-52.52139015255267, -22.76516503314214],
                  [-52.51830024776751, -22.760337142052627]]]),
            {
              "reference": 21,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.97409527050786, -22.797762101779682],
                  [-52.977700159423875, -22.788899763562704],
                  [-52.98027508007817, -22.797603850791745]]]),
            {
              "reference": 21,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.090825006835985, -22.73982997706688],
                  [-53.10713283764653, -22.749487038125938],
                  [-53.08550350415044, -22.740938199059116]]]),
            {
              "reference": 21,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.05632107006841, -22.77702965839733],
                  [-53.05975429760747, -22.772597887717048],
                  [-53.05992595898442, -22.776871383351292]]]),
            {
              "reference": 21,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.111081049316454, -22.812795107751125],
                  [-53.113312647216844, -22.80899745228838],
                  [-53.115544245117235, -22.814060969378414]]]),
            {
              "reference": 21,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.035378382080125, -22.796179583633247],
                  [-53.036408350341844, -22.79333100467662],
                  [-53.03898327099614, -22.79333100467662],
                  [-53.03726665722661, -22.797603850791745]]]),
            {
              "reference": 21,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.48228619256332, -22.861832921022067],
                  [-52.47850964227035, -22.86910884137654],
                  [-52.47559139886215, -22.868476168118352]]]),
            {
              "reference": 21,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.35798579158052, -22.865470929904312],
                  [-52.35472422541841, -22.863414675982668],
                  [-52.35901575984224, -22.861832921022067]]]),
            {
              "reference": 21,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.30047923030122, -22.867685322402036],
                  [-52.304599103348096, -22.870216012488093],
                  [-52.302367505447705, -22.872113999112347],
                  [-52.29824763240083, -22.870848677642975]]]),
            {
              "reference": 21,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.31730204524263, -22.911491234136903],
                  [-52.31232386531099, -22.91054251948688],
                  [-52.31455546321138, -22.90896131364984],
                  [-52.32073527278169, -22.910700639056277]]]),
            {
              "reference": 21,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.22408991755708, -23.02370886421744],
                  [-52.21516352595552, -23.024182825471165],
                  [-52.221000012771924, -23.021813002541247]]]),
            {
              "reference": 21,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.06650477351411, -23.004749048103033],
                  [-52.068393048660596, -23.001746832868218],
                  [-52.071139630691846, -23.003168943146598],
                  [-52.06787806452974, -23.008383219289765]]]),
            {
              "reference": 21,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.29824763240083, -23.060514892329298],
                  [-52.29618769587739, -23.06019900355736],
                  [-52.29481440486177, -23.05814570846798],
                  [-52.29773264826997, -23.057355971246903]]]),
            {
              "reference": 21,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.05723505915864, -22.97266929459659],
                  [-52.057406720535596, -22.97014051722291],
                  [-52.06255656184419, -22.972353200012133],
                  [-52.06186991633638, -22.97456584657893]]]),
            {
              "reference": 21,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.87504553929343, -23.196977775383953],
                  [-51.87178397313132, -23.198240038263492],
                  [-51.871440650377416, -23.196662207802],
                  [-51.87453055516257, -23.19539993002617]]]),
            {
              "reference": 21,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.7352289005141, -23.36755372891674],
                  [-51.74003541906879, -23.36582031993759],
                  [-51.73728883703754, -23.370547745602533]]]),
            {
              "reference": 21,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.67034090002582, -23.363298957341165],
                  [-51.66604936560199, -23.36455964463104],
                  [-51.66759431799457, -23.362353434010032]]]),
            {
              "reference": 21,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.55314341271297, -23.39938667488511],
                  [-51.54696360314266, -23.396235762345324],
                  [-51.554001719597736, -23.396708404006045]]]),
            {
              "reference": 21,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.55506313763344, -23.472541960173697],
                  [-51.55471981487953, -23.477895375295745],
                  [-51.55334652386391, -23.474903787741123]]]),
            {
              "reference": 21,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.474292919466485, -23.58860231873985],
                  [-51.47343461258172, -23.585770568577875],
                  [-51.47549454910516, -23.585927889634423],
                  [-51.47600953323602, -23.58954622188074]]]),
            {
              "reference": 21,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.4914590571618, -23.602917453467473],
                  [-51.49763886673211, -23.599142185003984],
                  [-51.49609391433953, -23.602445550853275]]]),
            {
              "reference": 21,
              "system:index": "24"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.29387681228875, -23.619747536017265],
                  [-51.28958527786492, -23.620219376343822],
                  [-51.29267518265008, -23.6173883088967]]]),
            {
              "reference": 21,
              "system:index": "25"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.22735867118288, -23.590794975533427],
                  [-51.22358212088991, -23.594255862679532],
                  [-51.223238798136, -23.59126692006576]]]),
            {
              "reference": 21,
              "system:index": "26"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.250095647854074, -23.717900121097955],
                  [-51.2459757748072, -23.718214445394278],
                  [-51.250095647854074, -23.71569982981148]]]),
            {
              "reference": 21,
              "system:index": "27"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.414890569729074, -23.823156328945377],
                  [-51.41592053799079, -23.818131104401193],
                  [-51.41901044277595, -23.818131104401193],
                  [-51.41643552212165, -23.824098536884183]]]),
            {
              "reference": 21,
              "system:index": "28"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.577453893703684, -23.85063458281518],
                  [-51.5810587826197, -23.84655246768241],
                  [-51.58037213711189, -23.850006573470946]]]),
            {
              "reference": 21,
              "system:index": "29"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.47050885586189, -23.851419590215894],
                  [-51.473083776516184, -23.85298959075169],
                  [-51.471023839992746, -23.854716569370968]]]),
            {
              "reference": 21,
              "system:index": "30"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.57110242275642, -23.90573054584317],
                  [-51.568184179348215, -23.90604441573443],
                  [-51.56732587246345, -23.904161184954933],
                  [-51.57127408413337, -23.90337649736605]]]),
            {
              "reference": 21,
              "system:index": "31"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.75151852993415, -23.942761929884995],
                  [-51.74791364101814, -23.942605039646082],
                  [-51.74911527065681, -23.94056544918141],
                  [-51.751690191311106, -23.94134991086744]]]),
            {
              "reference": 21,
              "system:index": "32"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.759929937404856, -23.905259739577286],
                  [-51.75924329189704, -23.90792761907661],
                  [-51.75615338711189, -23.907142954351865]]]),
            {
              "reference": 21,
              "system:index": "33"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.75563840298103, -23.922992257874107],
                  [-51.758728307766184, -23.92471830222763],
                  [-51.75615338711189, -23.925659771242856]]]),
            {
              "reference": 21,
              "system:index": "34"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.897259038967356, -23.900159008139084],
                  [-51.893310827297434, -23.895450665422725],
                  [-51.899490636867746, -23.892782528454475],
                  [-51.90292386440681, -23.897334023081804]]]),
            {
              "reference": 21,
              "system:index": "35"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.07166699795173, -23.809414798771087],
                  [-52.07492856411384, -23.805959612073025],
                  [-52.07510022549079, -23.80972890209398]]]),
            {
              "reference": 21,
              "system:index": "36"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.218609136623606, -23.789938909136577],
                  [-52.218094152492746, -23.784126989464216],
                  [-52.22049741177009, -23.78381282424144],
                  [-52.221355718654856, -23.788368145661714]]]),
            {
              "reference": 21,
              "system:index": "37"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.24367169765876, -23.77140268596577],
                  [-52.24813489345954, -23.769203298281173],
                  [-52.244873327297434, -23.776429718175784]]]),
            {
              "reference": 21,
              "system:index": "38"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.23817853359626, -23.781299470335053],
                  [-52.23165540127204, -23.780671125465418],
                  [-52.23165540127204, -23.77737226508417]]]),
            {
              "reference": 21,
              "system:index": "39"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.26495727557335, -23.73159582611147],
                  [-52.269592132751086, -23.733167274918905],
                  [-52.26615890521202, -23.735052988474873]]]),
            {
              "reference": 21,
              "system:index": "40"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.29791625994835, -23.672338391981263],
                  [-52.289333191100695, -23.667621791030932],
                  [-52.29396804827843, -23.66306224834281]]]),
            {
              "reference": 21,
              "system:index": "41"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.29053482073937, -23.64120568144378],
                  [-52.28229507464562, -23.642620965393185],
                  [-52.27972015399132, -23.634600820677942]]]),
            {
              "reference": 21,
              "system:index": "42"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.30512603778038, -23.6658923280406],
                  [-52.3032377626339, -23.66148995537452],
                  [-52.30649932879601, -23.65944594625204],
                  [-52.309589233581164, -23.664948974948036]]]),
            {
              "reference": 21,
              "system:index": "43"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.27436299784601, -23.615261252644785],
                  [-52.28088613017023, -23.613059233267663],
                  [-52.281744437054996, -23.61589039424249]]]),
            {
              "reference": 21,
              "system:index": "44"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.13582727232832, -23.58820530746843],
                  [-52.139432161244336, -23.583800323041913],
                  [-52.14132043639082, -23.58505890510842],
                  [-52.138230531605664, -23.58899189627064]]]),
            {
              "reference": 21,
              "system:index": "45"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.10837416989914, -23.462351683737136],
                  [-52.11215072019211, -23.46046204534954],
                  [-52.11163573606125, -23.465186090601293]]]),
            {
              "reference": 21,
              "system:index": "46"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.10253768308274, -23.46392636173117],
                  [-52.10270934445969, -23.456997638059164],
                  [-52.104082635475315, -23.46156433769606]]]),
            {
              "reference": 21,
              "system:index": "47"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.157984307838596, -23.448651192704467],
                  [-52.16261916501633, -23.448651192704467],
                  [-52.159014276100315, -23.45195833792002]]]),
            {
              "reference": 21,
              "system:index": "48"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.13721328122727, -23.43384676609551],
                  [-52.14133315427414, -23.435106781864235],
                  [-52.14013152463547, -23.43841426610962],
                  [-52.13549666745774, -23.437469279056725]]]),
            {
              "reference": 21,
              "system:index": "49"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.202959588600315, -23.430224153859637],
                  [-52.211714318824924, -23.43006664672802],
                  [-52.21377425534836, -23.433059250140907],
                  [-52.20364623410813, -23.433059250140907]]]),
            {
              "reference": 21,
              "system:index": "50"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.11352401120774, -23.456997638059164],
                  [-52.114038995338596, -23.45164337527661],
                  [-52.1169572387468, -23.452430780476803],
                  [-52.11627059323899, -23.454950445569985]]]),
            {
              "reference": 21,
              "system:index": "51"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.11197905881516, -23.44329659156986],
                  [-52.11163573606125, -23.446288895427408],
                  [-52.10871749265305, -23.442666624227545]]]),
            {
              "reference": 21,
              "system:index": "52"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.23883681638352, -23.388635759882217],
                  [-52.24295668943039, -23.385484591572027],
                  [-52.244673303199924, -23.38721774341782],
                  [-52.2378068481218, -23.392417062913406]]]),
            {
              "reference": 21,
              "system:index": "53"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.28896193845383, -23.384696787783703],
                  [-52.28776030881516, -23.377291203232605],
                  [-52.291880181862034, -23.382648476012893]]]),
            {
              "reference": 21,
              "system:index": "54"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.46216580797255, -23.377451533036975],
                  [-52.46817395616591, -23.376978822672662],
                  [-52.46525571275771, -23.38296636271373]]]),
            {
              "reference": 21,
              "system:index": "55"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.52121732164443, -23.379342357635313],
                  [-52.524822210560444, -23.38249367201947],
                  [-52.521045660267475, -23.38375417679045]]]),
            {
              "reference": 21,
              "system:index": "56"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.280588548441834, -23.300110890531766],
                  [-52.283335130473084, -23.304210029992024],
                  [-52.27749864365668, -23.308466694958568]]]),
            {
              "reference": 21,
              "system:index": "57"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.15485427901165, -23.264125642966206],
                  [-52.15021942183392, -23.266648887133115],
                  [-52.147987823933526, -23.26396793861946]]]),
            {
              "reference": 21,
              "system:index": "58"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.119835358113214, -23.264125642966206],
                  [-52.11485717818157, -23.26365252936613],
                  [-52.11949203535931, -23.26081381249596],
                  [-52.12412689253704, -23.26428334712634]]]),
            {
              "reference": 21,
              "system:index": "59"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.1399148190657, -23.16300344357265],
                  [-52.136824914280545, -23.161425197562608],
                  [-52.140086480442655, -23.158899965262158],
                  [-52.14266140109695, -23.158899965262158]]]),
            {
              "reference": 21,
              "system:index": "60"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.15690929538406, -23.16868497519863],
                  [-52.15416271335281, -23.167580251818595],
                  [-52.158797570530545, -23.163950382251027]]]),
            {
              "reference": 21,
              "system:index": "61"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.08769215871695, -23.110870917358106],
                  [-52.087520497339995, -23.10692373324939],
                  [-52.09507359792593, -23.110081489819404]]]),
            {
              "reference": 21,
              "system:index": "62"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.345639396073985, -23.111884398692638],
                  [-52.350102591874766, -23.10888457199672],
                  [-52.350617576005625, -23.113621109827672]]]),
            {
              "reference": 21,
              "system:index": "63"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.35954396760719, -23.093568622915313],
                  [-52.35525243318336, -23.096410889758598],
                  [-52.354394126298594, -23.09151583724826]]]),
            {
              "reference": 21,
              "system:index": "64"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.392846274736094, -23.15513760075406],
                  [-52.388039756181406, -23.15292792138011],
                  [-52.39336125886695, -23.14913981481282],
                  [-52.39799611604469, -23.153243592093354]]]),
            {
              "reference": 21,
              "system:index": "65"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.95284192130495, -23.04882759203772],
                  [-50.94794957206179, -23.051828758942005],
                  [-50.94391552970339, -23.04953840077075],
                  [-50.948979540323506, -23.04590533893906]]]),
            {
              "reference": 21,
              "system:index": "66"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.38482424528463, -22.933472488085812],
                  [-52.383536784957485, -22.93384795821392],
                  [-52.38463112623556, -22.932247262531778]]]),
            {
              "reference": 21,
              "system:index": "67"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.707504503178704, -22.830877892448044],
                  [-52.706238500523675, -22.829295759000246],
                  [-52.707214829662945, -22.82839591001207],
                  [-52.70814823334228, -22.827693830146774]]]),
            {
              "reference": 21,
              "system:index": "68"
            })]),
    agua = /* color: #ffff99 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.93727037276551, -22.943280854214702],
                  [-51.93624040450379, -22.942885650008733],
                  [-51.9340088066034, -22.942964690942237],
                  [-51.93482419814393, -22.942411403438413],
                  [-51.93684121932313, -22.942688047473027],
                  [-51.93799993361756, -22.943359894917428]]]),
            {
              "reference": 33,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.91686412658021, -22.957942114588146],
                  [-51.91632768477723, -22.95648001169595],
                  [-51.91628476943299, -22.954899342142372],
                  [-51.91538354720399, -22.953674310534456],
                  [-51.915469377892464, -22.953002514297854],
                  [-51.91675683821961, -22.954978376058722],
                  [-51.916713922875374, -22.95667759409145],
                  [-51.91714307631776, -22.957428404562133]]]),
            {
              "reference": 33,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.563229623707684, -22.721310109956484],
                  [-52.5639162692155, -22.722339312894814],
                  [-52.56331545439616, -22.72305183347077]]]),
            {
              "reference": 33,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.56636244383708, -22.711294769527406],
                  [-52.56709200468913, -22.710978066967712],
                  [-52.566705766590985, -22.712086522721165]]]),
            {
              "reference": 33,
              "system:index": "3"
            })]),
    varzea = /* color: #14feff */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-49.731349054913586, -23.390853354251067],
                  [-49.72825915012843, -23.3937680694075],
                  [-49.72920328770167, -23.389120249968116]]]),
            {
              "reference": 11,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-49.730919901471204, -23.385496413199416],
                  [-49.72920328770167, -23.38392080107926],
                  [-49.72645670567042, -23.382345170223292],
                  [-49.727143351178235, -23.38124221747685],
                  [-49.728602472882336, -23.38273907969372],
                  [-49.73074824009425, -23.3836056764069]]]),
            {
              "reference": 11,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-49.91394812654339, -23.038825594467863],
                  [-49.91034323762737, -23.043722564399037],
                  [-49.91188819001995, -23.038667624732156]]]),
            {
              "reference": 11,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-49.9036484439262, -23.050988707817677],
                  [-49.906566687334404, -23.045934040853673],
                  [-49.90691001008831, -23.05114666310305]]]),
            {
              "reference": 11,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-49.916008063066826, -23.069942018747973],
                  [-49.91789633821331, -23.077996367483813],
                  [-49.91566474031292, -23.074837856839505],
                  [-49.914806433428154, -23.071521340828276]]]),
            {
              "reference": 11,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-49.973686285723076, -23.083681499688108],
                  [-49.96784979890667, -23.08052312258529],
                  [-49.9695664126762, -23.078943906211077],
                  [-49.97179801057659, -23.080365201782524]]]),
            {
              "reference": 11,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-49.913776465166436, -23.119681752229514],
                  [-49.91549307893597, -23.11510330840802],
                  [-49.91497809480511, -23.122365594956037]]]),
            {
              "reference": 11,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.23201066495506, -22.9813609002901],
                  [-50.23501473905174, -22.98491668469347],
                  [-50.232954802528305, -22.989894625609526]]]),
            {
              "reference": 11,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.1583638876597, -22.962003871042153],
                  [-50.15887887179056, -22.95852651566068],
                  [-50.160852977625524, -22.96366348640751]]]),
            {
              "reference": 11,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.301710386177, -22.942676514762653],
                  [-50.30342699994653, -22.947735049267656],
                  [-50.3002512644729, -22.945680042428005],
                  [-50.29939295758813, -22.941174725936207]]]),
            {
              "reference": 11,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.31115176190942, -22.9444944473645],
                  [-50.31750323285669, -22.947893125424308],
                  [-50.30746104230493, -22.945601003080235]]]),
            {
              "reference": 11,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.53887106612684, -22.916286918941616],
                  [-50.53226210311414, -22.931069674358607],
                  [-50.53303457931043, -22.926247669377876],
                  [-50.53354956344129, -22.918658592602483]]]),
            {
              "reference": 11,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.683259757719114, -22.95930787936395],
                  [-50.675020011625364, -22.963259389811984],
                  [-50.67793825503357, -22.959782066713995]]]),
            {
              "reference": 11,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.864019187650754, -23.03357694095649],
                  [-50.8583543622113, -23.03278705965874],
                  [-50.85715273257263, -23.029943448654446],
                  [-50.860242637357786, -23.03183919599036]]]),
            {
              "reference": 11,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.024395402735365, -23.09488488317237],
                  [-51.01795810109962, -23.095042786916366],
                  [-51.021391328638686, -23.09425326634065]]]),
            {
              "reference": 11,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.34473686364579, -22.900384869582137],
                  [-51.34405021813798, -22.89358504437846],
                  [-51.34696846154618, -22.89880354529988],
                  [-51.351946641477824, -22.901017394133053]]]),
            {
              "reference": 11,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.1576587376895, -22.597677710236862],
                  [-52.15268055775786, -22.61590195774481],
                  [-52.15147892811919, -22.61209883584064],
                  [-52.14753071644927, -22.607027843077002],
                  [-52.14941899159575, -22.603224475853683],
                  [-52.15319554188872, -22.602907523840155],
                  [-52.156113785296924, -22.59419105744779]]]),
            {
              "reference": 11,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.1351426779362, -22.541906924066275],
                  [-52.11763321748698, -22.527161326875532],
                  [-52.12020813814128, -22.52525855449177],
                  [-52.13668763032878, -22.538577410727083]]]),
            {
              "reference": 11,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.113341683063155, -22.564260147682642],
                  [-52.110251778278, -22.58026980424472],
                  [-52.110251778278, -22.569015685350816]]]),
            {
              "reference": 11,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.130336159381514, -22.565052748684888],
                  [-52.12552964082683, -22.56410162693546],
                  [-52.131537789020186, -22.56235788668875]]]),
            {
              "reference": 11,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.13411270967448, -22.569015685350816],
                  [-52.134799355182295, -22.57868477268316],
                  [-52.13273941865886, -22.578367764182815],
                  [-52.13342606416667, -22.573454039169665],
                  [-52.132224434528, -22.56933271536293]]]),
            {
              "reference": 11,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.25844273159589, -22.664810539780536],
                  [-52.25981602261152, -22.671780174590534],
                  [-52.25518116543378, -22.672096967759046]]]),
            {
              "reference": 11,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.262390943265814, -22.665760965377356],
                  [-52.266854139066595, -22.662751261735593],
                  [-52.266854139066595, -22.665760965377356]]]),
            {
              "reference": 11,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.28695551976306, -22.667725070191192],
                  [-52.286097212878296, -22.668279474145073],
                  [-52.28669802769763, -22.665665835890035]]]),
            {
              "reference": 11,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.286354704943726, -22.68985988634939],
                  [-52.28395144566638, -22.69033501316634],
                  [-52.285410567370484, -22.687959362608574]]]),
            {
              "reference": 11,
              "system:index": "24"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.81750392792394, -23.119164578660616],
                  [-52.81686019776036, -23.11967767236797],
                  [-52.817031859137316, -23.117309531198313]]]),
            {
              "reference": 11,
              "system:index": "25"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-49.848870158880594, -23.747612335613994],
                  [-49.850329280584695, -23.74833904369415],
                  [-49.850318551748636, -23.748830060371485],
                  [-49.84912765094602, -23.74807389391857]]]),
            {
              "reference": 11,
              "system:index": "26"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.99288721629567, -23.898281535549543],
                  [-51.992586808886, -23.898673895400975],
                  [-51.99215765544362, -23.897379103373073]]]),
            {
              "reference": 11,
              "system:index": "27"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.96027155467458, -23.89706521244412],
                  [-51.95945616313405, -23.896555138059526],
                  [-51.961086946215104, -23.894946428744817]]]),
            {
              "reference": 11,
              "system:index": "28"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.95216055461354, -23.90463761855018],
                  [-51.951817231859636, -23.904402213641248],
                  [-51.9526755387444, -23.902989775185347]]]),
            {
              "reference": 11,
              "system:index": "29"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.96331326529909, -23.049222486241515],
                  [-50.96082417533327, -23.04756392280369],
                  [-50.96236912772585, -23.04709004378382],
                  [-50.96580235526491, -23.048116779552664]]]),
            {
              "reference": 11,
              "system:index": "30"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.00185124442507, -23.064148637787984],
                  [-51.0006496147864, -23.06335893579147],
                  [-51.002194567178975, -23.063516876561533]]]),
            {
              "reference": 11,
              "system:index": "31"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.975243730997335, -23.04756392280369],
                  [-50.97481457755495, -23.046379222127534],
                  [-50.97781865165163, -23.044799605014983]]]),
            {
              "reference": 11,
              "system:index": "32"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.97378460929323, -23.042509127295244],
                  [-50.96940724418093, -23.04227217910124],
                  [-50.9731837944739, -23.04108743187928]]]),
            {
              "reference": 11,
              "system:index": "33"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.01961819693972, -23.03389974206514],
                  [-51.018674059366475, -23.034531642256244],
                  [-51.018931551431905, -23.032793909600837]]]),
            {
              "reference": 11,
              "system:index": "34"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.88091580436159, -23.04203523049043],
                  [-50.881602449869405, -23.043535897986168],
                  [-50.878340883707295, -23.04448367936931]]]),
            {
              "reference": 11,
              "system:index": "35"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.004683657144795, -23.023749439249368],
                  [-51.00382535026003, -23.025645273696473],
                  [-51.00279538199831, -23.02501333184295],
                  [-51.00365368888308, -23.023986420013188]]]),
            {
              "reference": 11,
              "system:index": "36"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.9006568633127, -23.009945347351614],
                  [-50.898682756610825, -23.008365302548622],
                  [-50.89926211343765, -23.008207298791117],
                  [-50.90014187895568, -23.008602310448694],
                  [-50.90084997966982, -23.00883931723852],
                  [-50.90125767839591, -23.009945347351607]]]),
            {
              "reference": 11,
              "system:index": "37"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.033847670486146, -23.142548552611615],
                  [-53.032646040847474, -23.1454292434048],
                  [-53.031916479995424, -23.1442059439185],
                  [-53.03341851704376, -23.142864247773797]]]),
            {
              "reference": 11,
              "system:index": "38"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.58429039445548, -23.14049931341725],
                  [-53.582144627243565, -23.138092076563684],
                  [-53.58549202409415, -23.13742119957574]]]),
            {
              "reference": 11,
              "system:index": "39"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.58000125055131, -23.133615631411242],
                  [-53.58085955743608, -23.134345723985735],
                  [-53.578692332552045, -23.135805897210457],
                  [-53.578155890749066, -23.13511527672091]]]),
            {
              "reference": 11,
              "system:index": "40"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.32582030201008, -22.911854013371105],
                  [-53.326421116829415, -22.913632830683923],
                  [-53.32410368824055, -22.911221539368007]]]),
            {
              "reference": 11,
              "system:index": "41"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.357663487434884, -22.92256609348376],
                  [-53.35659060382893, -22.92213130229127],
                  [-53.35826430225422, -22.921894142870944]]]),
            {
              "reference": 11,
              "system:index": "42"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.30788168811848, -22.931064004800053],
                  [-53.30809626483967, -22.92987828173712],
                  [-53.30637965107014, -22.929245891859047],
                  [-53.30934080982258, -22.928811122105113]]]),
            {
              "reference": 11,
              "system:index": "43"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.317800847797486, -22.93255230058533],
                  [-53.31651338747034, -22.933145151708686],
                  [-53.31642755678186, -22.93184087581144]]]),
            {
              "reference": 11,
              "system:index": "44"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.14987358486327, -23.021798861453405],
                  [-53.14974483883056, -23.025590558544966],
                  [-53.14892944729003, -23.023655226477956]]]),
            {
              "reference": 11,
              "system:index": "45"
            })]),
    flo = /* color: #98ff00 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.86565536831087, -22.926330044991012],
                  [-51.86578411434358, -22.92138929108843],
                  [-51.87080520961946, -22.921507871292327]]]),
            {
              "reference": 3,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-51.87380928371614, -22.924709497568553],
                  [-51.873723453027665, -22.92166597806941],
                  [-51.87715668056673, -22.92158692470392]]]),
            {
              "reference": 3,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.487851372271685, -22.920931244724706],
                  [-53.480856171160845, -22.92124745944007],
                  [-53.48227237752071, -22.912986107830765]]]),
            {
              "reference": 3,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-53.51813860151485, -23.184489253697986],
                  [-53.513246252271685, -23.18985428963809],
                  [-53.51367540571407, -23.18559383751124]]]),
            {
              "reference": 3,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-50.519744376681, -23.102303201681643],
                  [-50.52746913864389, -23.095987248505168],
                  [-50.52592418625131, -23.101829515494398],
                  [-50.520259360811856, -23.105303175405695]]]),
            {
              "reference": 3,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.51181194939926, -22.856771181426343],
                  [-52.50803539910629, -22.863889198880425],
                  [-52.50786373772934, -22.854872980477662]]]),
            {
              "reference": 3,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-52.58013299270077, -22.824765714896575],
                  [-52.57940343184872, -22.825675474152643],
                  [-52.57880261702938, -22.823776839244314]]]),
            {
              "reference": 3,
              "system:index": "6"
            })]),
    campo = /* color: #d63000 */ee.FeatureCollection([]);

// Define the region ID (reg_12)
var regiaoID = 'reg_12'; // old 11

// Define whether to collect data (false)
var coleta = false;   // true or false

// Define the years to process (2016-2023)
var anos = [2016,2017,2018,2019,2020,2021,2022,2023]

// If collecting data, only process 2023
if (coleta) {var anos = [2023]}

// Define the number of trees for the Random Forest classifier (100)
var RFtrees = 100;

// If collecting data, use 200 trees
if (coleta) {var RFtrees = 200}

// Define the output version (1)
var versao_out = 1;

// Define the version of the point data (S2_v1)
var versao_pt = 'S2_v1';

// Define the stable version (3)
var versao_estavel = '3'

// Define the input directory for point data
var dir_pt_in = 'projects/mapbiomas-workspace/AMOSTRAS/col9/MATA_ATLANTICA/teste/';

// Load the 250k biome collection
var bioma250mil = ee.FeatureCollection('projects/mapbiomas-workspace/AUXILIAR/biomas_IBGE_250mil');

// Filter the collection to only include the Mata Atlântica biome
var bioma250mil_MA_vetor = bioma250mil.filterMetadata('Bioma','equals', 'Mata Atlântica');

// Load the biome raster
var biomes = ee.Image('projects/mapbiomas-workspace/AUXILIAR/biomas-raster-41');

// Mask the biome raster to only include the Mata Atlântica biome
var bioma250mil_MA = biomes.mask(biomes.eq(2));

// Add the Mata Atlântica biome layer to the map
Map.addLayer(bioma250mil_MA,{},'layer bioma',false)

// Import the palettes module
var palettes = require('users/mapbiomas/modules:Palettes.js');

// Define the visualization parameters for the classification
var vis = {
    'min': 0,
    'max': 62,
    'palette': palettes.get('classification7')
};

// Load the regions collection
var regioesCollection = ee.FeatureCollection('projects/mapbiomas-workspace/AUXILIAR/Mata_Atlantica_col6_PLANET');

// Define the visualization parameters for the median composite
var visParMedian2 = {bands: ['swir1_median', 'nir_median', 'red_median'],gain: [0.08, 0.06, 0.2],gamma: 0.85}

// Define the biome name (MATAATLANTICA)
var bioma = "MATAATLANTICA";

// Define the output directory
var dirout = 'projects/mapbiomas-workspace/COLECAO7/classificacao-ma/';

// Load the S2 cluster image
var S2_cluster = ee.Image('projects/mapbiomas-workspace/AMOSTRAS/S2_2024/MATA_ATLANTICA/mosaicos_MA_S2_clusters_2106_2023')

// Filter the regions collection to only include the specified region ID
var limite = regioesCollection.filterMetadata('reg_id', "equals", regiaoID);
//var limite = reg_04_rev

// Load the stable map from collection 6
var mapa_estavel_col6 = ee.Image('projects/mapbiomas-workspace/AMOSTRAS/col7/MATA_ATLANTICA/MA_amostras_estaveis85a20_col6_v1')

// Add the stable map layer to the map
Map.addLayer(mapa_estavel_col6, vis, 'mapa_estavel_col6', false);

// Create a blank image
var blank = ee.Image(0).mask(0);
// Outline the region boundary
var outline = blank.paint(limite, 'AA0000', 2); 
// Define the visualization parameters for the outline
var visPar = {'palette':'000000','opacity': 0.6};
// Add the outline layer to the map
Map.addLayer(outline, visPar, regiaoID, false);

// Define a function to shuffle a feature collection
var shuffle = function (collection, seed) {
    // Add a random column to the collection
    collection = collection.randomColumn('random', seed || 1)
        // Sort the collection by the random column
        .sort('random', true)
        // Map over the collection and set a new ID based on the random column
        .map(function (feature) {
                var rescaled = ee.Number(feature.get('random')).multiply(1000000000).round();
                return feature.set('new_id', rescaled)});
    // Get a list of the new IDs
    var randomIdList = ee.List(collection.reduceColumns(ee.Reducer.toList(), ['new_id']).get('list'));
    // Create a sequential list of IDs
    var sequentialIdList = ee.List.sequence(1, collection.size());
    // Remap the collection using the new IDs
    var shuffled = collection.remap(randomIdList, sequentialIdList, 'new_id');
    // Return the shuffled collection
    return shuffled;
};

// Define the visualization parameters for the hand-labeled data
var vis_hand = {
    'min': 0,
    'max': 60,
    'palette': 'blue,white,green,orange,red,brown'
};

// Loop through the years
for (var i_ano=0;i_ano<anos.length; i_ano++){
  // Get the current year
  var ano = anos[i_ano];

  // Define the asset path for the Sentinel-2 mosaics
  var asset = 'projects/mapbiomas-mosaics/assets/SENTINEL/BRAZIL/mosaics-3';
  // Define the band names to use for classification
  var bandNames = ee.List([
  // THE 60 MOST IMPORTANT BANDS FOR THIS REGION
  'red_median','latitude','longitude','nddi_median_wet','red_edge_2_median_dry','nddi_median','green_median_wet','swir1_stdDev','red_edge_2_median','nir_median','shape_median_dry','evi_median_wet','red_median_wet','green_min','red_edge_1_median_dry','blue_median_dry','osavi_median_dry','ndwi_median','rvi_median_1','gvmi_median_dry','swir2_median','brightness_median','swir1_median_dry','brba_median_wet','blue_median','ndvi_median_wet_'+ano,'swir1_median_wet','iia_median','green_median_texture_'+ano,'ndvi_median_dry_'+ano,'gcvi_median_dry','iia_median_dry','awei_median_wet','shape_median','avi_median_wet','gemi_median','lai_median','brba_median_dry','lswi_median_wet','ri_median_wet','nddi_median_dry','spri_median','red_edge_1_median_wet','gli_median','co2flux_median','ui_median','brba_median','red_edge_1_median','ndwi_median_wet','rvi_median','wetness_median','wetness_median_wet','brightness_median_dry','lswi_median','mbi_median','ratio_median_dry','awei_median','afvi_median_wet','green_median_texture','blue_median_wet',

  // ALL 143 BANDS TO FEATURE IMPORTANCE
  //    'blue_median','afvi_median','afvi_median_dry','afvi_median_wet','avi_median','avi_median_dry','avi_median_wet','awei_median','awei_median_dry','awei_median_wet','blue_median_dry','blue_median_wet','blue_stdDev','brba_median','brba_median_dry','brba_median_wet','brightness_median','brightness_median_dry','brightness_median_wet','bsi_median','bsi_median_1','bsi_median_2','clusters_2023','co2flux_median','cvi_median','cvi_median_dry','cvi_median_wet','dswi5_median','dswi5_median_dry','dswi5_median_wet','evi_median','evi_median_dry','evi_median_wet','gcvi_median','gcvi_median_dry','gcvi_median_wet','gemi_median','gemi_median_dry','gemi_median_wet','gli_median','gli_median_dry','gli_median_wet','green_median','green_median_dry','green_median_texture','green_median_texture_2023','green_median_wet','green_min','green_stdDev','gvmi_median','gvmi_median_1','gvmi_median_dry','gvmi_median_dry_1','gvmi_median_wet','gvmi_median_wet_1','iia_median','iia_median_dry','iia_median_wet','lai_median','latitude','longitude','lswi_median','lswi_median_dry','lswi_median_wet','mbi_median','mbi_median_dry','mbi_median_wet','msi_median','msi_median_dry','msi_median_wet','nddi_median','nddi_median_dry','nddi_median_wet','ndvi_median','ndvi_median_dry','ndvi_median_dry_2023','ndvi_median_wet','ndvi_median_wet_2023','ndwi_median','ndwi_median_2023','ndwi_median_dry','ndwi_median_wet','nir_median','nir_median_contrast','nir_median_dry','nir_median_dry_contrast','nir_median_wet','nir_stdDev','osavi_median','osavi_median_dry','osavi_median_wet','ratio_median','ratio_median_dry','ratio_median_wet','red_edge_1_median','red_edge_1_median_dry','red_edge_1_median_wet','red_edge_1_stdDev','red_edge_2_median','red_edge_2_median_dry','red_edge_2_median_wet','red_edge_2_stdDev','red_edge_3_median','red_edge_3_median_dry','red_edge_3_median_wet','red_edge_3_stdDev','red_edge_4_median','red_edge_4_median_dry','red_edge_4_median_wet','red_edge_4_stdDev','red_median','red_median_contrast','red_median_dry','red_median_dry_contrast','red_median_wet','red_min','red_stdDev','ri_median','ri_median_dry','ri_median_wet','rvi_median','rvi_median_1','rvi_median_wet','shape_median','shape_median_dry','shape_median_wet','spri_median','spri_median_1','spri_median_wet','swir1_median','swir1_median_dry','swir1_median_wet','swir1_stdDev','swir2_median','swir2_median_dry','swir2_median_wet','swir2_stdDev','ui_median','ui_median_dry','ui_median_wet','wetness_median','wetness_median_dry','wetness_median_wet',
  ])

  // Load the Sentinel-2 mosaic collection
  var collection = ee.ImageCollection(asset)
        // Filter the collection by version and year
        .filter(ee.Filter.eq('version', '3'))
        .filter(ee.Filter.eq('year', ano))
        // Filter the collection by biome
        .filter(ee.Filter.inList('biome', [
            'MATAATLANTICA',
        ])); 

  // Create a mosaic from the collection
  var mosaicoTotal = collection.mosaic()

  // Import the function to add indices for the Caatinga biome
  var addIndexCaatinga = require('users/marcosrosaUSP/MapBiomas_col9_MataAtlan:Mata_Atlantica_SENTINEL2/processa_Bandas_Sentinel2_CAATINGA');

  // Add the Caatinga indices to the mosaic
  mosaicoTotal = addIndexCaatinga.get(mosaicoTotal);

  // Add bands from the S2 cluster image to the mosaic
  mosaicoTotal = mosaicoTotal.addBands(S2_cluster.select([
    'clusters_'+ano, 'ndvi_median_dry_'+ano,'ndvi_median_wet_'+ano,'ndwi_median_'+ano, 'green_median_texture_'+ano
    ]))
    
  // Add the mosaic layer to the map
  Map.addLayer(mosaicoTotal, {'bands': ['swir1_median', 'nir_median', 'red_median'],
    'gain': [0.08, 0.07, 0.2],'gamma': 0.85}, 'Sentinel 2 '+ano, false);
  //print(mosaicoTotal)
  //var BDamostras = ee.FeatureCollection('projects/mapbiomas-workspace/AMOSTRAS/col9/MATA_ATLANTICA/teste/REGIONs_'+regiaoID+'_'+ano)

  // Load the training points
  var BDamostras = ee.FeatureCollection('projects/mapbiomas-workspace/AMOSTRAS/S2_2024/MATA_ATLANTICA/pontos_train_v1_'+ano)
                    // Filter the points by region ID
                    .filterMetadata('reg_id', 'equals', regiaoID)
          
  // Filter the training points by reference class
  var BDflo = BDamostras.filterMetadata("reference", "equals", 3)
  var BDsav = BDamostras.filterMetadata("reference", "equals", 4)//.limit(100)
  var BDreflo = BDamostras.filterMetadata("reference", "equals", 9)
  var BDvarzea = BDamostras.filterMetadata("reference", "equals", 11)
  var BDcampo = BDamostras.filterMetadata("reference", "equals", 12)
  var BDOutroNFlo = BDamostras.filterMetadata("reference", "equals", 13)
  var BDagro = BDamostras.filterMetadata("reference", "equals", 21)
  // BDagro = shuffle(BDagro, 2).limit(1000)
  var BDNaoVeg = BDamostras.filterMetadata("reference", "equals", 22)
  var BDAflora = BDamostras.filterMetadata("reference", "equals", 29)
  var BDagua = BDamostras.filterMetadata("reference", "equals", 33)

  // Complementary samples
  // Merge the training points for different classes
  var amostraTotal = flo.merge(agr).merge(agua).merge(varzea).merge(campo)
  
  // Reduce the training points to an image
  var amostraTotalimg = amostraTotal.reduceToImage({properties: ['reference'],reducer: ee.Reducer.first()})

  // Rename the band
  amostraTotalimg = amostraTotalimg.select([0],['reference'])

  // Sample the mosaic using the training points
  var training_flo = mosaicoTotal.select(bandNames).addBands(amostraTotalimg).sample({'numPixels': 900, 'region': flo.filterBounds(limite), 'scale': 10, 'seed': 1});
  // var training_nflo = mosaicoTotal.select(bandNames).addBands(amostraTotalimg).sample({'numPixels': 300, 'region': nao_flo.filterBounds(limite), 'scale': 10, 'seed': 1});
  // var training_sav = mosaicoTotal.select(bandNames).addBands(amostraTotalimg).sample({'numPixels': 1500, 'region': sav.filterBounds(limite), 'scale': 10, 'seed': 1});
  // var training_afl = mosaicoTotal.select(bandNames).addBands(amostraTotalimg).sample({'numPixels': 1000, 'region': aflora.filterBounds(limite), 'scale': 10, 'seed': 1});
  var training_var = mosaicoTotal.select(bandNames).addBands(amostraTotalimg).sample({'numPixels': 1100, 'region': varzea.filterBounds(limite), 'scale': 10, 'seed': 1});
  // var training_agu = mosaicoTotal.select(bandNames).addBands(amostraTotalimg).sample({'numPixels': 100, 'region': agua.filterBounds(limite), 'scale': 10, 'seed': 1});
  var training_cam = mosaicoTotal.select(bandNames).addBands(amostraTotalimg).sample({'numPixels': 800, 'region': campo.filterBounds(limite), 'scale': 10, 'seed': 1});
  // var training_nflo = mosaicoTotal.select(bandNames).addBands(amostraTotalimg).sample({'numPixels': 200, 'region': n_flo.filterBounds(limite), 'scale': 10, 'seed': 1});
  var training_agr = mosaicoTotal.select(bandNames).addBands(amostraTotalimg).sample({'numPixels': 1700, 'region': agr.filterBounds(limite), 'scale': 10, 'seed': 1});

// If collecting data, print the size of the training sets
if (coleta) {
// print('BDflo',BDflo.size())
// print('BDsav',BDsav.size())
// print('BDvar',BDvarzea.size())
// print('BDcam',BDcampo.size())
// print('BDOut',BDOutroNFlo.size())
// print('BDAfl',BDAflora.size())
// print('BDagr',BDagro.size())
// print('BDNao',BDNaoVeg.size())
// print('BDagu',BDagua.size())
print('training_flo',training_flo.size())
//print('training_cam',training_cam.size())
//print('training_sav',training_sav.size())
print('training_var',training_var.size())
print('training_cam',training_cam.size())
print('training_agr',training_agr.size())
}

  // Merge the training points for all classes
  var training = BDflo.merge(BDreflo).merge(BDcampo)//.merge(BDsav).merge(BDOutroNFlo).merge(BDAflora)
                      .merge(BDagro).merge(BDNaoVeg).merge(BDagua)
                      //complementares
                      // .merge(training_afl)
                      .merge(training_var)
                      .merge(training_cam)
                      .merge(training_agr).merge(training_flo)//.merge(training_agu).merge(training_agr)

  // Train a Random Forest classifier
  var classifierRF = ee.Classifier.smileRandomForest({numberOfTrees: RFtrees, variablesPerSplit:1}).train(training, 'reference', bandNames);

  // If collecting data, print the classifier explanation
  if (coleta) {print(classifierRF.explain())}

  // Train a Gradient Tree Boost classifier
  var classifierGTB = ee.Classifier.smileGradientTreeBoost({numberOfTrees: 30, shrinkage: 0.1, samplingRate: 0.8, loss: 'LeastSquares'}).train(training, 'reference', bandNames);

  // print(classifier.explain())

  // Classify the mosaic using the Random Forest classifier
  var classifiedRF = mosaicoTotal.classify(classifierRF).mask(mosaicoTotal.select('blue_median'));

  // Classify the mosaic using the Gradient Tree Boost classifier
  var classifiedGTB = mosaicoTotal.classify(classifierGTB).mask(mosaicoTotal.select('blue_median'));

  // Rename the classification band and clip the image to the region boundary
  classifiedRF = classifiedRF.select(['classification'],['classification_'+ano]).clip(limite.geometry()).toInt8()
  // classifiedGTB = classifiedGTB.select(['classification'],['classification_'+ano]).clip(limite.geometry()).toInt8()

  // If collecting data, add the classification layers to the map
  if (coleta) {  
    Map.addLayer(classifiedRF, vis, 'RF'+ano+"_"+regiaoID, false);
//    Map.addLayer(classifiedGTB, vis, 'GTB'+ano+"_"+regiaoID, false);
  }

  // If this is the first year, initialize the combined classification image
  if (i_ano == 0){ var classified16a23RF = classifiedRF;}//  var classified16a23GTB = classifiedGTB}  
  // Otherwise, add the current year's classification to the combined image
  else {classified16a23RF = classified16a23RF.addBands(classifiedRF);}// classified16a23GTB = classified16a23GTB.addBands(classifiedGTB)}
}

// If collecting data, do nothing
if (coleta) {}
// Otherwise, export the classification image to an asset
   else 
   {
     // Set metadata for the classification image
     classified16a23RF = classified16a23RF
     .set('territory', 'BRAZIL')
     .set('biome', 'MATA ATÂNTICA')
     .set('source', 'arcplan')
     .set('version', '1')
     .set('collection_id',versao_out)

//     classified16a23GTB = classified16a23GTB
//     .set('territory', 'BRAZIL')
//     .set('biome', 'MATA ATÂNTICA')
//     .set('source', 'arcplan')
//     .set('version', '1')
//     .set('collection_id',versao_out)
     
    // Export the Random Forest classification image to an asset
    Export.image.toAsset({
       "image": classified16a23RF.toInt8(),
       "description": regiaoID+'-'+'RF_SENTINEL2_v'+versao_out,
       "assetId": dirout + regiaoID+'-'+'RF_SENTINEL2_v'+versao_out,
       "scale": 10,
       "pyramidingPolicy": {
           '.default': 'mode'
       },
       "maxPixels": 1e13,
       "region": limite
     });    
     
//    Export.image.toAsset({
//       "image": classified16a23GTB.toInt8(),
//       "description": regiaoID+'-'+'GTB_SENTINEL2_v'+versao_out,
//       "assetId": dirout + regiaoID+'-'+'GTB_SENTINEL2_v'+versao_out,
//       "scale": 10,
//       "pyramidingPolicy": {
//           '.default': 'mode'
//       },
//       "maxPixels": 1e13,
//       "region": limite
//     });    
}
